<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CRM Fund Dashboard</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="myfortune.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>
<body>
  <header>
    <h1>Fund projections</h1>

  </header>
  <nav style="display: flex; align-items: center; gap: 2rem;">
    <button id="openSidebar" style="background: none; border: none; cursor: pointer; font-size: 1.7rem; margin-right: 1rem;" title="Paste Fund Data">
      <span style="display: inline-block; vertical-align: middle;">&#9776;</span>
    </button>
    <a href="index.html">Home</a>
    <a href="myfortune_Final.html">My Fortune</a>
    <button id="resetDefaults">Reset to Default</button>
    <!-- Add more navigation links here as you create new pages -->
  </nav>
  <!-- Main content -->
  <div class="container">
    <div class="main">

      <div class="dashboard">
        <div class="card" style="grid-column: span 2;">
          <h2>Fund Value Over Time</h2>
          <canvas id="fundChart"></canvas>
          <div id="fundTable" style="margin-top:1.5rem;"></div>
        </div>
        <div class="card" style="grid-column: span 2;">
          <h2>Projection Based on Average Gain</h2>
          <div id="avgGainInfo" style="margin-bottom: 0.7rem; color: var(--primary-dark); font-weight: 500;"></div>
          <label for="taxPercentInput">Tax %:</label>
          <input type="number" id="taxPercentInput" value="30" min="0" max="100" style="width:60px; margin-left:0.5rem; margin-bottom:0.5rem;">
          <label for="gainSlider" style="display:block;">Projected Annual Gain: <strong><span id="gainValue">10</span>%</strong></label>
          <input type="range" min="0" max="50" value="10" id="gainSlider"/>
          <label><input type="checkbox" id="deductBudget"/> Deduct budget from projection</label>
          <div id="deductPercentContainer" style="display:none; margin-top:0.5rem;">
            <label for="deductPercentSlider">Deduction Percentage: <strong><span id="deductPercentValue"></span>%</strong></label>
            <input type="range" min="0" max="100" id="deductPercentSlider"/>
          </div>
          <div style="display:flex; gap:1rem; align-items:center; margin-top:0.5rem;">
            <div id="deductYearContainer" style="display:none;">
              <label for="deductStartYearInput">Start Deduction Year:</label>
              <input type="number" id="deductStartYearInput" value="" min="" style="width:80px; margin-left:0.5rem;">
            </div>
            <div>
              <label for="projectionYearsInput">Projection Years:</label>
              <input type="number" id="projectionYearsInput" value="10" min="1" max="50" style="width:80px; margin-left:0.5rem;">
            </div>
          </div>
          <canvas id="projectionChart"></canvas>
          <div id="projectionTable" style="margin-top:1.5rem;"></div>
      </div>
    </div>
  </div>
  <script>
    // Default fund data for reset functionality
    const defaultFundData = [
      { year: 2023, start: 3500000, end: 3884487.8 },
      { year: 2024, start: 3884487.8, end: 4518572.58 },
      { year: 2025, start: 4518572.58, end: 4513769.85 }
    ];

    // Start with a copy of the default data
    let fundData = [...defaultFundData];

    function calculateDerivedData() {
      const years = fundData.map(d => d.year);
      const fundValues = fundData.map(d => d.end);
      const gains = fundData.map(d => d.end - d.start);
      const percents = fundData.map(d => d.start ? ((d.end - d.start)/d.start*100).toFixed(2) : 0);
      return { years, fundValues, gains, percents };
    }

    let { years, fundValues, gains, percents } = calculateDerivedData();

    const ctx = {
      fund: document.getElementById('fundChart').getContext('2d'),
      projection: document.getElementById('projectionChart').getContext('2d')
    };

    const chartOptions = {
      responsive: true,
      plugins: { legend: { position: 'bottom' } },
      elements: { line: { tension: 0.3 } }
    };

    const fundChart = new Chart(ctx.fund, {
      type: 'line',
      data: { labels: years, datasets: [{ label: 'Fund Value', data: fundValues, borderColor: '#2563eb', backgroundColor: 'rgba(37,99,235,0.1)', fill: true }] },
      options: chartOptions
    });

    const projectionChart = new Chart(ctx.projection, {
      type: 'line',
      data: { labels: [], datasets: [
        {
          label: 'Projected Fund Value',
          data: [],
          borderColor: '#f59e0b',
          backgroundColor: 'rgba(245,158,11,0.1)',
          fill: true,
          datalabels: {
            align: 'top',
            anchor: 'end',
            color: '#f59e0b',
            font: { weight: 'bold' },
            formatter: function(value) {
              return value ? value.toLocaleString('sv-SE', { maximumFractionDigits: 0 }) + ' SEK' : '';
            }
          }
        },
        {
          label: 'Projected Fund After Budget',
          data: [],
          borderColor: '#ef4444',
          backgroundColor: 'rgba(239,68,68,0.1)',
          fill: true,
          datalabels: {
            align: 'bottom',
            anchor: 'end',
            color: '#ef4444',
            font: { weight: 'bold' },
            formatter: function(value) {
              return value ? value.toLocaleString('sv-SE', { maximumFractionDigits: 0 }) + ' SEK' : '';
            }
          }
        }
      ]},
      options: {
        ...chartOptions,
        plugins: {
          ...chartOptions.plugins,
          datalabels: {
            display: true
          }
        }
      },
      plugins: [ChartDataLabels]
    });

    const gainSlider = document.getElementById('gainSlider');
    const gainValueLabel = document.getElementById('gainValue');
    const deductBudgetCheckbox = document.getElementById('deductBudget');
    const deductPercentContainer = document.getElementById('deductPercentContainer');
    const deductPercentSlider = document.getElementById('deductPercentSlider');
    const deductPercentValue = document.getElementById('deductPercentValue');
    const projectionYearsInput = document.getElementById('projectionYearsInput');
    const taxPercentInput = document.getElementById('taxPercentInput');
    const deductYearContainer = document.getElementById('deductYearContainer');
    const deductStartYearInput = document.getElementById('deductStartYearInput');
    // Default values as constants
    const DEFAULT_DEDUCT_PERCENT = 4;
    // Set deductStartYearInput value and min to next year dynamically
    const nextYear = new Date().getFullYear() + 1;
    deductStartYearInput.value = nextYear;
    deductStartYearInput.min = nextYear;
    // Set initial value for deduction percent slider and label
    deductPercentSlider.value = DEFAULT_DEDUCT_PERCENT;
    deductPercentValue.innerText = DEFAULT_DEDUCT_PERCENT;

    // Calculate total average annual gain
    function getTotalAverageAnnualGain() {
      let totalGain = 0;
      let totalStart = 0;
      let years = fundData.length;
      fundData.forEach(d => {
        totalGain += (d.end - d.start);
        totalStart += d.start;
      });
      // Average percent per year
      let avgPercent = fundData.reduce((sum, d) => sum + ((d.end - d.start) / d.start * 100), 0) / years;
      // Average actual gain per year
      let avgActual = totalGain / years;
      return { avgPercent: parseFloat(avgPercent.toFixed(2)), avgActual: Math.round(avgActual) };
    }

    const { avgPercent, avgActual } = getTotalAverageAnnualGain();

    document.addEventListener('DOMContentLoaded', () => {
      gainSlider.value = avgPercent;
      gainValueLabel.innerText = avgPercent;
      document.getElementById('avgGainInfo').innerHTML =
        `Total Average Annual Gain: <strong>${avgPercent}%</strong> (<strong>${avgActual.toLocaleString()} SEK</strong> per year)`;
      updateProjection();
    });

    function updateProjection() {
      const avgGain = parseFloat(gainSlider.value);
      gainValueLabel.innerText = avgGain;
      const projYears = parseInt(projectionYearsInput.value) || 20;
      const lastFund = fundValues[fundValues.length - 1] || 0;

      const projLabels = [];
      const projData = [];
      const projDataAfterBudget = [];
      const deductedAmounts = [];
      let fund = lastFund;
      let fundAfterBudget = lastFund;
      const deductPercent = parseFloat(deductPercentSlider.value);
      const deductStartYear = parseInt(deductStartYearInput.value);

      for (let i = 1; i <= projYears; i++) {
        const currentYear = fundData[fundData.length-1].year + i;
        projLabels.push(currentYear);
        fund = fund * (1 + avgGain/100);
        projData.push(fund);

        if (deductBudgetCheckbox.checked && currentYear >= deductStartYear) {
          fundAfterBudget = fundAfterBudget * (1 + avgGain/100);
          const currentBudget = fundAfterBudget * deductPercent / 100;
          fundAfterBudget -= currentBudget;
          projDataAfterBudget.push(fundAfterBudget);
          deductedAmounts.push(currentBudget);
        } else if (deductBudgetCheckbox.checked) {
          fundAfterBudget = fundAfterBudget * (1 + avgGain/100);
          projDataAfterBudget.push(undefined);
          deductedAmounts.push(undefined);
        } else {
          projDataAfterBudget.push(undefined);
          deductedAmounts.push(undefined);
        }
      }

      projectionChart.data.labels = projLabels;
      projectionChart.data.datasets[0].data = projData;
      projectionChart.data.datasets[1].data = projDataAfterBudget;
      projectionChart.update();

      renderProjectionTable(projLabels, projData, projDataAfterBudget, deductedAmounts);
      renderFundValueTable(years, fundValues, gains, percents);
    }

    function renderProjectionTable(labels, data, dataAfterBudget, deductedAmounts) {
      const tableContainer = document.getElementById('projectionTable');
      tableContainer.innerHTML = '';

      const table = document.createElement('table');
      table.style.width = '100%';
      table.style.borderCollapse = 'collapse';

      const header = table.createTHead();
      const headerRow = header.insertRow();
      [
        `Year`,
        `Projected Fund Value`,
        `Projected Fund After Budget`,
        `Amount Deducted`,
        `Net After Tax (${taxPercentInput.value}%)`
      ].forEach(text => {
        const th = document.createElement('th');
        th.innerText = text;
        th.style.padding = '0.8rem';
        th.style.backgroundColor = '#f1f5f9';
        th.style.borderBottom = '2px solid var(--divider)';
        th.style.textAlign = 'left';
        headerRow.appendChild(th);
      });

      const body = table.createTBody();
      labels.forEach((label, idx) => {
        const row = body.insertRow();
        // Calculate net after tax on deducted amount only
        const deducted = deductedAmounts[idx];
        const net = deducted !== undefined ? deducted * (1 - taxPercentInput.value/100) : undefined;
        [
          label,
          data[idx],
          dataAfterBudget[idx],
          deductedAmounts[idx],
          net
        ].forEach((value, colIdx) => {
          const cell = row.insertCell();
          if (colIdx === 4) {
            cell.innerText = value !== undefined ? value.toLocaleString('sv-SE', { maximumFractionDigits: 0 }) + ' SEK' : '-';
          } else {
            cell.innerText = value !== undefined ? value.toLocaleString('sv-SE', { maximumFractionDigits: 0 }) : '-';
          }
          cell.style.padding = '0.8rem';
          cell.style.borderBottom = '1px solid var(--divider)';
          if (colIdx === 0) {
            cell.style.fontWeight = '500';
          }
        });
      });

      tableContainer.appendChild(table);
    }

    function renderFundValueTable(labels, values, gains, percents) {
  const tableContainer = document.getElementById('fundTable');
  tableContainer.innerHTML = '';

  const table = document.createElement('table');
  table.style.width = '100%';
  table.style.borderCollapse = 'collapse';

  const header = table.createTHead();
  const headerRow = header.insertRow();
  ['Year', 'Fund Value (SEK)', 'Gain/Loss (SEK)', 'Gain/Loss (%)'].forEach(text => {
    const th = document.createElement('th');
    th.innerText = text;
    th.style.padding = '0.8rem';
    th.style.backgroundColor = '#f1f5f9';
    th.style.borderBottom = '2px solid var(--divider)';
    th.style.textAlign = 'left';
    headerRow.appendChild(th);
  });

  const body = table.createTBody();
  labels.forEach((label, idx) => {
    const row = body.insertRow();
    [label, values[idx], gains[idx], percents[idx]].forEach((value, colIdx) => {
      const cell = row.insertCell();
      if (colIdx === 2) {
        cell.innerText = value !== undefined ? value.toLocaleString('sv-SE', { maximumFractionDigits: 0 }) : '-';
      } else if (colIdx === 3) {
        cell.innerText = value !== undefined ? value.toLocaleString('sv-SE', { maximumFractionDigits: 2 }) + ' %' : '-';
      } else {
        cell.innerText = value !== undefined ? value : '-';
      }
      cell.style.padding = '0.8rem';
      cell.style.borderBottom = '1px solid var(--divider)';
      if (colIdx === 0) {
        cell.style.fontWeight = '500';
      }
    });
  });
  // Add footer row for average annual gain
  const footerRow = body.insertRow();
  const cell1 = footerRow.insertCell();
  cell1.innerText = "Average Annual Gain";
  cell1.style.padding = '0.8rem';
  cell1.style.borderBottom = '1px solid var(--divider)';
  cell1.style.fontWeight = '500';

  const cell2 = footerRow.insertCell();
  cell2.innerText = '-';
  cell2.style.padding = '0.8rem';
  cell2.style.borderBottom = '1px solid var(--divider)';

  const cell3 = footerRow.insertCell();
  cell3.innerText = avgActual.toLocaleString('sv-SE', { maximumFractionDigits: 0 }) + ' SEK per year';
  cell3.style.padding = '0.8rem';
  cell3.style.borderBottom = '1px solid var(--divider)';

  const cell4 = footerRow.insertCell();
  cell4.innerText = avgPercent.toLocaleString('sv-SE', { maximumFractionDigits: 2 }) + ' %';
  cell4.style.padding = '0.8rem';
  cell4.style.borderBottom = '1px solid var(--divider)';

  tableContainer.appendChild(table);
}
    gainSlider.addEventListener('input', updateProjection);
    deductBudgetCheckbox.addEventListener('change', () => {
      deductPercentContainer.style.display = deductBudgetCheckbox.checked ? 'block' : 'none';
      deductYearContainer.style.display = deductBudgetCheckbox.checked ? 'block' : 'none';
      updateProjection();
    });
    deductPercentSlider.addEventListener('input', () => {
      deductPercentValue.innerText = deductPercentSlider.value;
      updateProjection();
    });
    projectionYearsInput.addEventListener('input', updateProjection);
    taxPercentInput.addEventListener('input', updateProjection);
    deductStartYearInput.addEventListener('input', updateProjection);

    updateProjection();

    // Reset to Default button functionality
    document.getElementById('resetDefaults').addEventListener('click', () => {
      fundData.forEach((d, idx) => {
        d.start = defaultFundData[idx].start;
        d.end = defaultFundData[idx].end;
      });
      ({ years, fundValues, gains, percents } = calculateDerivedData());

      // Reset inputs
      gainSlider.value = avgPercent;
      gainValueLabel.innerText = avgPercent;
      deductBudgetCheckbox.checked = false;
      deductPercentContainer.style.display = 'none';
      deductPercentSlider.value = DEFAULT_DEDUCT_PERCENT;
      deductPercentValue.innerText = DEFAULT_DEDUCT_PERCENT;
      projectionYearsInput.value = 10;
      taxPercentInput.value = 30;
      deductYearContainer.style.display = 'none';
      // Set deductStartYearInput back to nextYear dynamically
      deductStartYearInput.value = nextYear;
      deductStartYearInput.min = nextYear;

      updateProjection();

});
  document.addEventListener('DOMContentLoaded', () => {
    const sidebar = document.getElementById('fundSidebar');
    const overlay = document.getElementById('sidebarOverlay');
    const openSidebarBtn = document.getElementById('openSidebar');
    const closeSidebarBtn = document.getElementById('closeSidebar');

    openSidebarBtn.addEventListener('click', () => {
      sidebar.style.left = '0';
      overlay.style.display = 'block';
    });

    closeSidebarBtn.addEventListener('click', () => {
      sidebar.style.left = '-350px';
      overlay.style.display = 'none';
    });

    overlay.addEventListener('click', () => {
      sidebar.style.left = '-350px';
      overlay.style.display = 'none';
    });

    // Handle paste fund data
    const applyFundJsonBtn = document.getElementById('applyFundJson');
    const fundJsonInput = document.getElementById('fundJsonInput');
    const jsonError = document.getElementById('jsonError');

    applyFundJsonBtn.addEventListener('click', () => {
      try {
        const parsed = JSON.parse(fundJsonInput.value);
        if (
          Array.isArray(parsed) &&
          parsed.every(d => typeof d.year === 'number' && typeof d.start === 'number' && typeof d.end === 'number')
        ) {
          fundData = parsed;
          fundData.sort((a, b) => a.year - b.year);
          ({ years, fundValues, gains, percents } = calculateDerivedData());
          updateProjection();
          jsonError.textContent = '';
          // Optionally close sidebar after applying
          document.getElementById('fundSidebar').style.left = '-350px';
          document.getElementById('sidebarOverlay').style.display = 'none';
        } else {
          throw new Error('Invalid format');
        }
      } catch (err) {
        jsonError.textContent = 'Invalid JSON or format. Example: [{"year":2023,"start":3500000,"end":3884487.8}]';
      }
    });
  });
</script>

<!-- Place this just before </body> -->
<div id="sidebarOverlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(30,41,59,0.25); z-index:999;"></div>
<aside id="fundSidebar" style="position:fixed; top:0; left:-350px; width:350px; height:100vh; background:#fff; box-shadow:2px 0 16px rgba(0,0,0,0.08); z-index:1000; transition:left 0.3s; padding:2rem 1.5rem; display:flex; flex-direction:column;">
  <button id="closeSidebar" style="align-self:flex-end; background:none; border:none; font-size:1.5rem; cursor:pointer; color:#2d3e50;">&times;</button>
  <h2 style="margin-top:0;">Paste Fund Data (JSON)</h2>
  <textarea id="fundJsonInput" rows="8" style="width:100%;font-family:monospace; margin-bottom:1rem;" placeholder='[{"year":2023,"start":3500000,"end":3884487.8}]'></textarea>
  <button id="applyFundJson" style="margin-bottom:0.5rem;">Apply Data</button>
  <div id="jsonError" style="color:#ef4444;margin-top:0.5rem;"></div>
</aside>
</body>
</html>